{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/auth/index.js","webpack:///./src/auth/router.js","webpack:///./src/auth/store.js","webpack:///./src/core/Issue.js","webpack:///./src/core/ValidationError.js","webpack:///./src/core/index.js","webpack:///./src/core/wsBroadcast.js","webpack:///./src/index.js","webpack:///./src/item/Item.js","webpack:///./src/item/ItemStore.js","webpack:///./src/item/itemRouter.js","webpack:///./src/utils.js","webpack:///external \"@koa/cors\"","webpack:///external \"http\"","webpack:///external \"jsonwebtoken\"","webpack:///external \"koa\"","webpack:///external \"koa-bodyparser\"","webpack:///external \"koa-jwt\"","webpack:///external \"koa-router\"","webpack:///external \"nedb-promise\"","webpack:///external \"ws\""],"names":["router","Router","createToken","user","jwt","sign","username","_id","jwtConfig","secret","expiresIn","createUser","response","userStore","insert","body","token","status","err","issue","error","message","post","ctx","request","credentials","findOne","password","UserStore","constructor","filename","autoload","store","dataStore","props","SEVERITY","ERROR","WARNING","INFO","Issue","severity","code","details","ValidationError","Error","issues","idGenerator","id","next","wss","init","server","WebSocket","Server","on","ws","JSON","parse","signInfo","verify","userId","e","console","log","close","brodcast","event","payload","clients","forEach","readyState","OPEN","send","stringify","app","Koa","require","createServer","callback","use","cors","logger","errorHandler","bodyparser","prefix","publicApiRouter","authRouter","routes","allowedMethods","koaJwt","protectedApiRouter","itemRouter","listen","Item","text","isActive","prototype","toString","validate","item","trim","length","push","match","keys","Object","i","k","ItemStore","db","find","update","remove","count","datastore","ensureValidItem","itemStore","get","query","state","params","res","version","put","oldItem","newItemList","newItem","delete","found","start","Date","now","method","url"],"mappings":"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","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","export * from './router';\r\n","import Router from 'koa-router';\r\nimport userStore from './store';\r\nimport jwt from 'jsonwebtoken';\r\nimport { jwtConfig } from \"../core\";\r\n\r\nexport const router = new Router();\r\n\r\nconst createToken = (user) => {\r\n    return jwt.sign({ username: user.username, _id: user._id }, jwtConfig.secret, { expiresIn: 60 * 60 * 60 });\r\n};\r\n\r\nconst createUser = async (user, response) => {\r\n    try {\r\n        await userStore.insert(user);\r\n        response.body = { token: createToken(user) };\r\n        response.status = 201; // created\r\n    } catch (err) {\r\n        response.body = { issue: [{ error: err.message }] };\r\n        response.status = 400; // bad request\r\n    }\r\n};\r\n\r\nrouter.post('/signup', async (ctx) => await createUser(ctx.request.body, ctx.response));\r\n\r\nrouter.post('/login', async (ctx) => {\r\n    const credentials = ctx.request.body;\r\n    const response = ctx.response;\r\n    const user = await userStore.findOne({ username: credentials.username });\r\n    if (user && credentials.password === user.password) {\r\n        response.body = { token: createToken(user) };\r\n        response.status = 201; // created\r\n    } else {\r\n        response.body = { issue: [{ error: 'Invalid credentials' }] };\r\n        response.status = 400; // bad request\r\n    }\r\n});\r\n","import dataStore from 'nedb-promise';\r\n\r\nexport class UserStore {\r\n    constructor({ filename, autoload }) {\r\n        this.store = dataStore({ filename, autoload });\r\n    }\r\n\r\n    async findOne(props) {\r\n        return this.store.findOne(props);\r\n    }\r\n\r\n    async insert(user) {\r\n        //\r\n        return this.store.insert(user);\r\n    };\r\n}\r\n\r\nexport default new UserStore({ filename: './db/users.json', autoload: true });\r\n","export const SEVERITY = {\r\n    ERROR: 'error',\r\n    WARNING: 'warning',\r\n    INFO: 'information'\r\n};\r\n\r\nexport function Issue(severity, code, details) {\r\n    this.severity = severity;\r\n    this.code = code;\r\n    this.details = details;\r\n}","export class ValidationError extends Error {\r\n    constructor(issues) {\r\n        super('validation error');\r\n        this.issues = issues;\r\n    }\r\n}","export * from './ValidationError';\r\nexport * from './Issue';\r\nexport * from './wsBroadcast';\r\n\r\nexport const idGenerator = (() => {\r\n    let id = 0;\r\n    return {\r\n        next: () => ++id\r\n    }\r\n}) ();\r\n\r\nexport const jwtConfig = { secret: 'my-secret' };\r\n","import WebSocket from \"ws\";\r\nimport jwt from 'jsonwebtoken';\r\nimport {jwtConfig} from \"../core\";\r\n\r\nlet wss;\r\n\r\nexport const init = server => {\r\n    wss = new WebSocket.Server({ server });\r\n    wss.on('connection', ws => {\r\n        ws.on('message', message => {\r\n            // console.log('received: %s', message);\r\n            const {token} = JSON.parse(message);\r\n            try {\r\n                const signInfo = jwt.verify(token, jwtConfig.secret);\r\n                ws.user = {userId: signInfo._id};\r\n                // console.log(signInfo);\r\n            }\r\n            catch (e) {\r\n                console.log('auth error ', e);\r\n                ws.close();\r\n            }\r\n\r\n        });\r\n    });\r\n};\r\n\r\nexport const brodcast = ({event, payload}) => {\r\n    // console.log(\"broadcast: \");\r\n    // console.log(event, payload);\r\n    wss.clients.forEach(ws => {\r\n        const userId = ws.user ? ws.user.userId : null;\r\n        // console.log('userid:', userId);\r\n        // console.log('payloaduserid:', payload.userId);\r\n        if (ws.readyState === WebSocket.OPEN && userId === payload.userId) {\r\n            console.log('send: ', event, payload);\r\n            ws.send(JSON.stringify({event, payload}));\r\n        }\r\n    });\r\n};\r\n","import Koa from 'koa';\r\nimport { router as itemRouter } from './item/itemRouter';\r\nimport { logger, errorHandler } from \"./utils\";\r\nimport WebSocket from 'ws';\r\nimport bodyparser from 'koa-bodyparser';\r\nimport { init, jwtConfig } from './core';\r\nimport cors from '@koa/cors';\r\nimport koaJwt from 'koa-jwt';\r\nimport {router as authRouter} from \"./auth\";\r\nimport Router from 'koa-router';\r\n\r\nconst app = new Koa();\r\nconst server = require('http').createServer(app.callback());\r\napp.use(cors());\r\n\r\ninit(server);\r\n\r\napp.use(logger);\r\napp.use(errorHandler);\r\napp.use(bodyparser());\r\n\r\n// app.use(function *(){\r\n//     this.set('Access-Control-Allow-Origin', '*');\r\n// });\r\n\r\n// public\r\n\r\nconst prefix = '/api';\r\nconst publicApiRouter = new Router({ prefix });\r\npublicApiRouter\r\n  .use('/auth', authRouter.routes());\r\napp\r\n  .use(publicApiRouter.routes())\r\n  .use(publicApiRouter.allowedMethods());\r\n\r\n// app.use(async (ctx, next) => {\r\n//     console.log('before: ', ctx.state);\r\n//     await next();\r\n// });\r\napp.use(koaJwt(jwtConfig));\r\n// app.use(async (ctx, next) => {\r\n//     console.log('after: ', ctx.state);\r\n//     await next();\r\n// });\r\n\r\n//protected\r\nconst protectedApiRouter = new Router({ prefix });\r\nprotectedApiRouter\r\n    .use('/item', itemRouter.routes());\r\napp\r\n    .use(protectedApiRouter.routes())\r\n    .use(protectedApiRouter.allowedMethods());\r\n\r\n// app\r\n//     .use(itemRouter.routes())\r\n//     .use(itemRouter.allowedMethods());\r\n\r\nserver.listen(3000);\r\n\r\n\r\n\r\n\r\n\r\n// app.use(async(ctx, next) => {\r\n//     await new Promise((resolve => {\r\n//         setTimeout(resolve, 3000);\r\n//     }));\r\n//     await next();\r\n// });\r\n","import { Issue, SEVERITY } from \"../core\";\r\n\r\n\r\nexport function Item(text, isActive) {\r\n    this.text = text;\r\n    this.isActive = isActive;\r\n}\r\n\r\nItem.prototype.toString = function (){\r\n    return `${this.text} ${this.isActive}`;\r\n};\r\n\r\nexport const validate = (item) => {\r\n    const issues = [];\r\n    if (!item.text || typeof item.text !== 'string' || item.text.trim().length === 0) {\r\n        issues.push(new Issue(SEVERITY.WARNING, 'text', 'Invalid text property'));\r\n    }\r\n    return issues;\r\n};\r\n\r\n\r\n","import {idGenerator, ValidationError, Issue, SEVERITY} from '../core';\r\nimport {validate} from './Item';\r\nimport datastore from 'nedb-promise';\r\n\r\nconst match = (props, item) => {\r\n    const keys = Object.keys(props);\r\n    let i;\r\n    for (i = 0; i < keys.length; i++) {\r\n        const k = keys[i];\r\n        if (props[k] !== item[k]) {\r\n            break;\r\n        }\r\n    }\r\n    return i >= keys.length;\r\n};\r\n\r\nexport class ItemStore {\r\n    constructor({filename}) {\r\n        this.db = datastore({filename, autoload: true});\r\n    }\r\n\r\n    static ensureValidItem(item) {\r\n        if (!item) {\r\n            throw new ValidationError([new Issue(SEVERITY.WARNING, 'item', 'Invalid argument')]);\r\n        }\r\n        const issues = validate(item);\r\n        if (issues.length > 0) {\r\n            throw new ValidationError(issues);\r\n        }\r\n    }\r\n\r\n    async insert(item) {\r\n        // return new Promise((resolve, reject) => {\r\n        //         try {\r\n        //             ItemStore.ensureValidItem(item);\r\n        //             item.id = idGenerator.next();\r\n        //             this.items.push(item);\r\n        //             resolve(item);\r\n        //         } catch (e) {\r\n        //             reject(e);\r\n        //         }\r\n        //     }\r\n        // );\r\n\r\n        ItemStore.ensureValidItem(item);\r\n        // item.id = idGenerator.next();\r\n        return this.db.insert(item);\r\n    }\r\n\r\n    find = async (props) => {\r\n        return this.db.find(props);\r\n        // return this.db.find(props)\r\n        //     .sort({text: 1})\r\n        //     .skip(page * limit)\r\n        //     .limit(limit);\r\n\r\n\r\n\r\n        // return new Promise(((resolve, reject) => {\r\n        //     try {\r\n        //         const result = [];\r\n        //         this.items.forEach(item => {\r\n        //             if (match(props, item)) {\r\n        //                 result.push(item);\r\n        //             }\r\n        //         });\r\n        //         resolve(result);\r\n        //     } catch (e) {\r\n        //         reject(e);\r\n        //     }\r\n        // }));\r\n    };\r\n\r\n    update = async (props, item) => {\r\n        return this.db.update(props, item);\r\n        // return new Promise(((resolve, reject) => {\r\n        //     try {\r\n        //         const filteredItems = this.items\r\n        //             .filter(it => match(props, it));\r\n        //         filteredItems\r\n        //             .forEach(it => Object.assign(it, item));\r\n        //         resolve(filteredItems.length);\r\n        //     } catch (e) {\r\n        //         reject(e);\r\n        //     }\r\n        // }));\r\n    };\r\n\r\n    remove = async props => {\r\n        return this.db.remove(props);\r\n        // return new Promise(((resolve, reject) => {\r\n        //     try {\r\n        //         let count = 0;\r\n        //         for (let i = this.items.length - 1; i >= 0; i--) {\r\n        //             if (match(props, this.items[i])) {\r\n        //                 this.items.splice(i, 1);\r\n        //                 count++;\r\n        //             }\r\n        //         }\r\n        //         resolve(count);\r\n        //     } catch (e) {\r\n        //         reject(e);\r\n        //     }\r\n        // }));\r\n    };\r\n\r\n    count = async props => {\r\n        return this.db.count(props);\r\n        // return new Promise(((resolve, reject) => {\r\n        //     try {\r\n        //         const c = this.items\r\n        //             .filter(it => match(props, it))\r\n        //             .length;\r\n        //         resolve(c);\r\n        //     } catch (e) {\r\n        //         reject(e);\r\n        //     }\r\n        // }));\r\n    }\r\n\r\n}\r\n","import Router from 'koa-router';\r\nimport { ItemStore } from './ItemStore';\r\nimport {Item} from \"./Item\";\r\nimport { brodcast } from \"../core/wsBroadcast\";\r\n\r\nconst itemStore = new ItemStore({filename: './db/items.json'});\r\n\r\n// for(let i = 3; i < 55; i++){\r\n//     const txt = 'item' + i;\r\n//     var item = new Item(txt, 'false');\r\n//     item.userId = \"43RBCV8x6gWu871H\";\r\n//     item.version = 1;\r\n//     itemStore.insert(item);\r\n// }\r\n\r\n\r\nexport const router = new Router();\r\n\r\n// router.get('/item', async (ctx, next) => {\r\n//     ctx.response.body = await itemStore.find({});\r\n//     ctx.response.status = 200;\r\n// });\r\n\r\nrouter.get('/', async (ctx, next) => {\r\n    // const page = ctx.params.page || 0;\r\n    // const limit = ctx.params.limit || 10;\r\n\r\n    const props = ctx.query;\r\n    // var res = await itemStore\r\n    //     .find({...props, userId: ctx.state.user._id});\r\n    //\r\n    // res = res.slice(page * limit, page * limit + limit);\r\n\r\n    // ctx.response.body = res;\r\n\r\n    ctx.response.body = await itemStore\r\n        .find({...props, userId: ctx.state.user._id});\r\n    ctx.response.status = 200;\r\n});\r\n\r\nrouter.get('/:id', async (ctx, next) => {\r\n    console.log(ctx.params.id);\r\n    const res = await itemStore.find({_id: ctx.params.id});\r\n    console.log(res);\r\n    if(res.length === 0){\r\n        ctx.response.status = 404;\r\n    }\r\n    else {\r\n        if(ctx.state.user._id !== res[0].userId){\r\n            ctx.response.status = 403;\r\n        }\r\n        else {\r\n            ctx.response.body = res[0];\r\n            ctx.response.status = 200;\r\n        }\r\n    }\r\n});\r\n\r\n\r\n\r\nrouter.post('/', async (ctx, next) => {\r\n    const userId = ctx.state.user._id;\r\n    const item = await itemStore.insert({...ctx.request.body, userId, version: 1});\r\n    ctx.response.body = item;\r\n    ctx.response.status = 200;\r\n    // console.log(item);\r\n    brodcast({event: 'created', payload: item});\r\n});\r\n\r\nrouter.put('/:id', async (ctx, next) => {\r\n    const props = ctx.request.body;\r\n    const id = ctx.params.id;\r\n    const version = props.version;\r\n    const oldItem = await itemStore.find({_id: id});\r\n    if(oldItem.length === 0){\r\n        ctx.response.status = 404;\r\n        return;\r\n    }\r\n    if(oldItem[0].version > version){\r\n        ctx.response.status = 409; //conflict\r\n        ctx.response.body = oldItem[0];\r\n        return;\r\n    }\r\n    props.version += 1;\r\n    const count = await itemStore.update({_id: id}, props);\r\n    const newItemList = await itemStore.find({_id: id});\r\n    const newItem = newItemList[0];\r\n    console.log('newItem: ', newItem);\r\n    ctx.response.status = 200;\r\n    ctx.response.body = newItem;\r\n    brodcast({event: 'updated', payload: newItem });\r\n});\r\n\r\nrouter.delete('/:id', async (ctx, next) => {\r\n    const props = {_id: ctx.params.id};\r\n    const found = await itemStore.find(props);\r\n    const payload = found[0];\r\n    const count = await itemStore.remove(props);\r\n    // ctx.response.body = \"DELETED: \" + count;\r\n    ctx.response.status = 200;\r\n    brodcast({event: 'deleted', payload: payload});\r\n});\r\n","//error handler:\r\nexport const errorHandler = async (ctx, next) => {\r\n    try{\r\n        await next();\r\n    } catch (e) {\r\n        ctx.response.status = e.status || 500; //internal server error\r\n        ctx.response.body = e.message || 'Internal Server Error';\r\n    }\r\n};\r\n\r\nexport const logger = async (ctx, next) => {\r\n    let start = Date.now();\r\n    await next();\r\n    console.log(`${ctx.request.method} ${ctx.request.url} ${Date.now() - start} ms`);\r\n};\r\n","module.exports = require(\"@koa/cors\");","module.exports = require(\"http\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"koa\");","module.exports = require(\"koa-bodyparser\");","module.exports = require(\"koa-jwt\");","module.exports = require(\"koa-router\");","module.exports = require(\"nedb-promise\");","module.exports = require(\"ws\");"],"sourceRoot":""}